scriptencoding utf-8

if !empty(globpath(&rtp, 'autoload/nayvy.vim'))
    finish
endif

py3 << EOF

import vim
from nayvy_vim_if import *

def nayvy_list_imports_no_color() -> List[str]:
    ''' List all available imports
    '''
    filepath = vim.eval('expand("%")')
    stmt_map = init_import_stmt_map(filepath)
    if stmt_map is None:
        return []
    return [
        single_import.to_line(color=False)
        for _, single_import in stmt_map.items()
    ]

EOF


function! lf#navvy#source_type() abort
    return 'funcref'
endfunction


function! lf#navvy#source(args) abort
    return py3eval('nayvy_list_imports_no_color()')
endfunction


function! lf#navvy#accept(line, args) abort
    let l:names = [split(a:line, ' : ')[0]]
    let l:py_expr = 'nayvy_import(' . string(l:names) . ')'
    call py3eval(l:py_expr)
endfunction


function! lf#navvy#get_digest(line, mode) abort
    if a:mode ==# 0
        return [a:line, 0]
    elseif a:mode ==# 1
        let l:end = stridx(a:line, ' : ')
        return [a:line[:l:end-1], 0]
    else
        let l:start = stridx(a:line, ' : ')
        return [a:line[l:start : -1], strlen(a:line)]
    endif
endfunction


" ====================
" supports_name_only
" ====================
function! lf#navvy#supports_name_only() abort
    return v:true
endfunction
